<div class="rich-text-container">
  <div class="toolbar">
    <button class="tool-button bold-button" data-command="bold">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" color="#000000" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8.4384 2C8.45887 2.00001 8.47941 2.00001 8.50001 2.00001H13.079C16.0895 2.00001 18.5 4.4792 18.5 7.50001C18.5 10.5208 16.0895 13 13.079 13H5.50001C4.94772 13 4.50001 12.5523 4.50001 12V6.00001C4.50001 5.97941 4.50001 5.95887 4.5 5.9384C4.49994 5.28428 4.49989 4.69656 4.56384 4.22085C4.63367 3.70149 4.7958 3.16868 5.23224 2.73224C5.66868 2.2958 6.20149 2.13367 6.72085 2.06384C7.19656 1.99989 7.78428 1.99994 8.4384 2ZM6.64692 4.14593C6.64671 4.14617 6.64656 4.14635 6.64645 4.14645C6.64635 4.14656 6.64617 4.14671 6.64593 4.14692C6.63942 4.15261 6.58457 4.2005 6.54601 4.48735C6.50213 4.8137 6.50001 5.26463 6.50001 6.00001V11H13.079C14.9517 11 16.5 9.44976 16.5 7.50001C16.5 5.55025 14.9517 4.00001 13.079 4.00001H8.50001C7.76463 4.00001 7.3137 4.00213 6.98735 4.04601C6.7005 4.08457 6.65261 4.13942 6.64692 4.14593Z" fill="currentColor" />
            <path fill-rule="evenodd" clip-rule="evenodd" d="M5.50001 11C6.05229 11 6.50001 11.4477 6.50001 12V18C6.50001 18.7354 6.50213 19.1863 6.54601 19.5127C6.58457 19.7995 6.63942 19.8474 6.64593 19.8531C6.64617 19.8533 6.64635 19.8534 6.64645 19.8536C6.64656 19.8537 6.64671 19.8538 6.64693 19.8541C6.65261 19.8606 6.7005 19.9154 6.98735 19.954C7.3137 19.9979 7.76463 20 8.50001 20H14.1667C15.9724 20 17.5 18.4689 17.5 16.5C17.5 14.5311 15.9724 13 14.1667 13H12.9286C12.3763 13 11.9286 12.5523 11.9286 12C11.9286 11.4477 12.3763 11 12.9286 11H14.1667C17.1474 11 19.5 13.4983 19.5 16.5C19.5 19.5017 17.1474 22 14.1667 22H8.50001C8.47941 22 8.45887 22 8.4384 22C7.78427 22.0001 7.19656 22.0001 6.72085 21.9362C6.20149 21.8663 5.66868 21.7042 5.23224 21.2678C4.7958 20.8313 4.63367 20.2985 4.56384 19.7792C4.49989 19.3035 4.49994 18.7157 4.5 18.0616C4.50001 18.0411 4.50001 18.0206 4.50001 18V12C4.50001 11.4477 4.94772 11 5.50001 11Z" fill="currentColor" />
        </svg>    
    </button>
    <button class="tool-button italic-button" data-command="italic">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" color="#000000" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M11 4C11 3.44772 11.4477 3 12 3H19C19.5523 3 20 3.44772 20 4C20 4.55228 19.5523 5 19 5H12C11.4477 5 11 4.55228 11 4Z" fill="currentColor" />
            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.4472 3.10555C16.9412 3.35254 17.1414 3.95321 16.8944 4.44719L8.8944 20.4472C8.64741 20.9412 8.04674 21.1414 7.55276 20.8944C7.05878 20.6474 6.85856 20.0467 7.10555 19.5528L15.1055 3.55276C15.3525 3.05878 15.9532 2.85856 16.4472 3.10555Z" fill="currentColor" />
            <path fill-rule="evenodd" clip-rule="evenodd" d="M4 20C4 19.4477 4.44772 19 5 19L12 19C12.5523 19 13 19.4477 13 20C13 20.5523 12.5523 21 12 21L5 21C4.44772 21 4 20.5523 4 20Z" fill="currentColor" />
        </svg>
    </button>
    <button class="tool-button link-button">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" color="#000000" fill="none">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M15.2071 8.79285C15.5976 9.18337 15.5976 9.81654 15.2071 10.2071L10.2071 15.2071C9.81658 15.5976 9.18342 15.5976 8.79289 15.2071C8.40237 14.8165 8.40237 14.1834 8.79289 13.7928L13.7929 8.79285C14.1834 8.40232 14.8166 8.40232 15.2071 8.79285Z" fill="currentColor" />
        <path fill-rule="evenodd" clip-rule="evenodd" d="M11.2929 3.837C13.7423 1.3876 17.7136 1.3876 20.163 3.837C22.6124 6.2864 22.6124 10.2577 20.163 12.7071L17.7071 15.1629C17.3166 15.5534 16.6834 15.5534 16.2929 15.1629C15.9024 14.7724 15.9024 14.1392 16.2929 13.7487L18.7487 11.2928C20.4171 9.6245 20.4171 6.91957 18.7487 5.25122C17.0804 3.58287 14.3755 3.58287 12.7071 5.25122L10.2513 7.70706C9.86074 8.09759 9.22757 8.09759 8.83705 7.70706C8.44652 7.31654 8.44652 6.68337 8.83705 6.29285L11.2929 3.837ZM7.70711 8.837C8.09763 9.22753 8.09763 9.86069 7.70711 10.2512L5.25126 12.7071C3.58291 14.3754 3.58291 17.0803 5.25126 18.7487C6.91961 20.417 9.62454 20.417 11.2929 18.7487L13.7487 16.2928C14.1393 15.9023 14.7724 15.9023 15.1629 16.2928C15.5535 16.6834 15.5535 17.3165 15.1629 17.7071L12.7071 20.1629C10.2577 22.6123 6.28645 22.6123 3.83705 20.1629C1.38765 17.7135 1.38765 13.7422 3.83705 11.2928L6.29289 8.837C6.68342 8.44648 7.31658 8.44648 7.70711 8.837Z" fill="currentColor" />
      </svg>
    </button>
  </div>
  <div class="editor" contenteditable="true" placeholder="Type something..."></div>
  
  <div id="linkModal" class="link-modal">
    <div class="link-modal-content">
      <div class="link-field-group">
        <label for="linkInput">Pagina / URL</label>
        <input type="text" id="linkInput" placeholder="your website URL" autofocus>
      </div>
      <div class="link-field-group">
        <label for="linkTitleInput">Link text</label>
        <input type="text" id="linkTitleInput" placeholder="">
      </div>
      <div class="link-actions">
        <button id="removeLink" class="remove-link-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Verwijder link
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.rich-text-container {
  width: 100%;
  max-width: 600px;
  border: 1px solid #EAEAEA;
  border-radius: 8px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  position: relative;
}

.toolbar {
  display: flex;
  padding: 10px 14px;
  border-bottom: 1px solid #EAEAEA;
}

.tool-button {
  width: 32px;
  height: 32px;
  margin-right: 8px;
  border: none;
  background-color: transparent;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #37352F;

  font-size: 14px;
}

.tool-button:hover {
  background-color: #F7F7F7;
}

.editor {
  line-height: 1.5;
  color: #37352F;
  font-size: 15px;
  padding: 12px 14px;
}

.editor:empty:before {
  content: attr(placeholder);
  color: #B3B3B1;
}

.editor:focus {
  outline: none;
}

.editor a {
  color: #0B6FFF;
  text-decoration: none;
  border-bottom: 1px solid #0B6FFF;
}

/* Link Modal */
.link-modal {
  position: absolute;
  top: 50px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 8px;
  box-shadow: rgba(15, 15, 15, 0.05) 0px 0px 0px 1px, rgba(15, 15, 15, 0.1) 0px 3px 6px, rgba(15, 15, 15, 0.2) 0px 9px 24px;
  width: 360px;
  display: none;
  z-index: 1000;
  overflow: visible;
}

.link-modal-content {
  padding: 14px 16px 10px;
}

.link-field-group {
  margin-bottom: 10px;
}

.link-field-group:last-of-type {
  margin-bottom: 0;
}

.link-field-group label {
  display: block;
  font-size: 12px;
  color: rgba(55, 53, 47, 0.65);
  margin-bottom: 6px;
  font-weight: 500;
}

#linkInput, #linkTitleInput {
  width: 100%;
  padding: 8px 10px;
  border: none;
  border-radius: 3px;
  font-size: 14px;
  line-height: 20px;
  box-sizing: border-box;
  background-color: rgba(242, 241, 238, 0.6);
  color: #37352F;
  transition: background-color 0.1s ease;
}

#linkInput:focus, #linkTitleInput:focus {
  outline: none;
  background-color: rgba(242, 241, 238, 1);
}

.link-actions {
  border-top: 1px solid rgba(55, 53, 47, 0.09);
  padding-top: 4px;
  margin-top: 6px;
  margin-left: -16px;
  margin-right: -16px;
}

.remove-link-btn {
  display: flex;
  align-items: center;
  background: none;
  border: none;
  color: rgba(55, 53, 47, 0.65);
  font-size: 14px;
  cursor: pointer;
  padding: 6px 16px;
  width: 100%;
  text-align: left;
  transition: background-color 0.1s ease;
}

.remove-link-btn svg {
  margin-right: 8px;
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.remove-link-btn:hover {
  background-color: rgba(55, 53, 47, 0.08);
}
</style>

<script>

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', initializeRichTextEditor);

  // Initialize all elements and event listeners
function initializeRichTextEditor() {
  const editor = document.querySelector('.editor');
  const linkModal = document.getElementById('linkModal');
  const linkInput = document.getElementById('linkInput');
  const linkTitleInput = document.getElementById('linkTitleInput');
  const removeLink = document.getElementById('removeLink');
  
  if (editor) {
    editor.focus();
  }
  
  // Handle format buttons
  document.querySelectorAll('.tool-button[data-command]').forEach(btn => {
    btn.addEventListener('mousedown', function(e) {
      // Don't let focus leave the editor
      e.preventDefault();
    });
    
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const command = this.getAttribute('data-command');
      formatText(command);
    });
  });
  
  // Ensure the link button has a direct event listener
  const linkButton = document.querySelector('.link-button');
  if (linkButton) {
    // Save selection on mousedown before focus leaves the editor
    linkButton.addEventListener('mousedown', function(e) {
      saveSelection();
    });
    
    linkButton.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      showLinkModal();
    });
  }
  
  // Handle link application (auto-submit when pressing Enter)
  linkInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      applyLink();
    }
  });
  
  linkTitleInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      applyLink();
    }
  });
  
  // Handle remove link button
  if (removeLink) {
    removeLink.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      removeExistingLink();
    });
  }
}

// Global functions for link handling
function applyLink() {
  const linkModal = document.getElementById('linkModal');
  const linkInput = document.getElementById('linkInput');
  const linkTitleInput = document.getElementById('linkTitleInput');
  const editor = document.querySelector('.editor');
  
  const url = linkInput.value.trim();
  const linkTitle = linkTitleInput.value.trim() || url.replace(/^https?:\/\//, '');
  
  if (url) {
    restoreSelection();
    if (editor) editor.focus();
    
    // Always use insertHTML for consistent behavior
    const linkHTML = `<a href="${url}">${linkTitle}</a>`;
    try {
      document.execCommand('insertHTML', false, linkHTML);
    } catch (err) {
      console.error('Failed to apply link:', err);
      // Fallback: manually insert
      if (savedSelection) {
        savedSelection.deleteContents();
        const el = document.createElement("div");
        el.innerHTML = linkHTML;
        const frag = document.createDocumentFragment();
        let node, lastNode;
        while ((node = el.firstChild)) {
          lastNode = frag.appendChild(node);
        }
        savedSelection.insertNode(frag);
      }
    }
  }
  
  linkModal.style.display = 'none';
  if (editor) editor.focus();
}

function removeExistingLink() {
  const linkModal = document.getElementById('linkModal');
  const editor = document.querySelector('.editor');
  
  restoreSelection();
  if (editor) editor.focus();
  
  const selection = window.getSelection();
  if (selection.rangeCount > 0) {
    const range = selection.getRangeAt(0);
    let parentElement = range.commonAncestorContainer;
    
    if (parentElement.nodeType === 3) {
      parentElement = parentElement.parentElement;
    }
    
    if (parentElement && parentElement.tagName === 'A') {
      const textContent = parentElement.textContent;
      const textNode = document.createTextNode(textContent);
      parentElement.parentNode.replaceChild(textNode, parentElement);
    }
  }
  
  linkModal.style.display = 'none';
  if (editor) editor.focus();
}

// Format text (bold, italic)
function formatText(command) {
  const editor = document.querySelector('.editor');
  if (!editor) return;
  
  editor.focus();
  document.execCommand(command, false, null);
}

// Link modal handling
function showLinkModal() {
  // Get the modal elements
  const linkModal = document.getElementById('linkModal');
  const linkInput = document.getElementById('linkInput');
  const linkTitleInput = document.getElementById('linkTitleInput');
  const removeLink = document.getElementById('removeLink');
  
  if (!linkModal || !linkInput || !linkTitleInput) return;
  
  saveSelection();
  
  // Check if we're editing an existing link
  let existingUrl = '';
  let existingText = '';
  let isEditingLink = false;
  
  if (savedSelection) {
    let container = savedSelection.commonAncestorContainer;
    if (container.nodeType === 3) container = container.parentElement;
    
    const anchor = container.closest('a');
    if (anchor) {
      existingUrl = anchor.getAttribute('href') || '';
      existingText = anchor.textContent || '';
      isEditingLink = true;
      
      // Select the whole anchor so we replace it when applying
      const range = document.createRange();
      range.selectNode(anchor);
      savedSelection = range;
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    } else {
      existingText = savedSelection.toString();
    }
  }
  
  linkModal.style.display = 'block';
  linkModal.style.zIndex = '1000';
  linkInput.value = existingUrl;
  linkTitleInput.value = existingText;
  
  // Always show remove button, but only enable it when editing a link
  if (removeLink) {
    removeLink.style.display = 'flex';
    if (!isEditingLink) {
      removeLink.style.opacity = '0.3';
      removeLink.style.pointerEvents = 'none';
    } else {
      removeLink.style.opacity = '1';
      removeLink.style.pointerEvents = 'auto';
    }
  }
  
  linkInput.focus();
}

// These functions are now moved to the initializeRichTextEditor function
// to ensure they're only set up after DOM is loaded

// Close modal if clicking outside
document.addEventListener('click', function(e) {
  const linkModal = document.getElementById('linkModal');
  const linkInput = document.getElementById('linkInput');
  const editor = document.querySelector('.editor');
  
  if (linkModal && linkModal.style.display === 'block' && 
      !linkModal.contains(e.target) && 
      !e.target.closest('.link-button')) {
    
    // Auto-apply link if URL is filled
    if (linkInput && linkInput.value.trim()) {
      applyLink();
    } else {
      linkModal.style.display = 'none';
      restoreSelection();
      if (editor) editor.focus();
    }
  }
});

// Selection management
let savedSelection = null;
let savedSelectionText = '';

function saveSelection() {
  if (window.getSelection) {
    const sel = window.getSelection();
    if (sel.getRangeAt && sel.rangeCount) {
      savedSelection = sel.getRangeAt(0).cloneRange();
      savedSelectionText = sel.toString();
      console.log('Selection saved:', savedSelectionText);
    } else {
      // If no selection, set cursor in editor
      const editor = document.querySelector('.editor');
      if (editor) {
        const range = document.createRange();
        range.setStart(editor, 0);
        range.collapse(true);
        savedSelection = range;
      }
    }
  }
}

function restoreSelection() {
  if (savedSelection) {
    try {
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedSelection);
      console.log('Selection restored');
    } catch (e) {
      console.error('Error restoring selection:', e);
      // Focus the editor as fallback
      const editor = document.querySelector('.editor');
      if (editor) {
        editor.focus();
      }
    }
  } else {
    // Focus the editor if no selection was saved
    const editor = document.querySelector('.editor');
    if (editor) {
      editor.focus();
    }
  }
}
</script>
